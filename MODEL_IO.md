# 模型输入输出说明

## 🔍 图像特征验证结果

**验证命令：**
```bash
python verify_image_features.py
```

**验证结果：**
- ✅ **图像特征存在**：在 `mouse_brain_squidpy.h5ad` 文件中确认存在 `image_features`
- **特征规格**：
  - 形状：`(2688, 1024)`
  - 类型：`numpy.ndarray`
  - 维度：每个 spot 包含 1024 维图像特征
  - 非零值比例：100.00%（所有特征值均为有效数值）
- **示例值**：`[-0.47818294, -2.0024734, -2.4401646, -0.9185863, -0.14932792]`

**空间坐标信息：**
- ✅ **空间坐标存在**：`adata.obsm['spatial']`
- **坐标规格**：`(2688, 2)` - 2688 个 spot 的 x、y 坐标
- **示例坐标**：`[[8230, 7237], [4170, 1611], [2519, 8315]]`

## 📥 模型输入

### 1. 真实数据输入

**数据格式**：AnnData 对象 (.h5ad 文件)

**核心输入组件：**

| 组件名称 | 数据类型 | 形状 | 来源 | 说明 |
|---------|---------|------|------|------|
| 基因表达矩阵 | 数组 | `(N_spots, N_genes)` | `adata.X` | 空间转录组基因表达数据 |
| 空间坐标 | 数组 | `(N_spots, 2)` | `adata.obsm['spatial']` | 每个 spot 的 x、y 坐标 |
| 图像特征 | 数组 | `(N_spots, 1024)` | `adata.obsm['image_features']` | 从组织图像中提取的深度特征 |
| 空间邻接图 | 数组 | `(2, N_edges)` | 动态生成 | 基于空间坐标构建的 kNN 图 |

### 2. 合成数据输入

**数据格式**：随机生成的空间转录组数据

**核心输入组件：**

| 组件名称 | 数据类型 | 形状 | 来源 | 说明 |
|---------|---------|------|------|------|
| 基因表达矩阵 | 数组 | `(1000, 2000)` | 动态生成 | 模拟的基因表达数据，包含 5 个空间簇 |
| 空间坐标 | 数组 | `(1000, 2)` | 动态生成 | 2D 平面上的均匀分布坐标 |
| 图像特征 | 数组 | `(1000, 1024)` | 动态生成 | 基于空间簇生成的模拟图像特征 |
| 空间邻接图 | 数组 | `(2, N_edges)` | 动态生成 | 基于空间坐标构建的 kNN 图 (k=6) |

## 📤 模型输出

### 1. 训练过程输出

| 输出文件 | 数据类型 | 形状 | 说明 |
|---------|---------|------|------|
| `checkpoint_epoch_*.pt` | PyTorch 模型 | - | 不同训练阶段的模型检查点 |
| `latent_representations.npy` | numpy 数组 | `(N_spots, 32)` | 每个 spot 的 32 维潜在表示 |
| `kl_divergence.npy` | numpy 数组 | `(N_spots,)` | 每个 spot 的条件 KL 散度 |
| `true_labels.npy` | numpy 数组 | `(N_spots,)` | 真实空间簇标签（合成数据） |

### 2. 聚类分析输出

| 输出文件 | 数据类型 | 形状 | 说明 |
|---------|---------|------|------|
| `cluster_labels.npy` | numpy 数组 | `(N_spots,)` | K-Means 聚类结果 |
| `cluster_centers.npy` | numpy 数组 | `(K, 32)` | K 个簇的中心点 |
| `clustering_analysis.png` | PNG 图像 | - | 聚类分析可视化 |
| `clustering_report.md` | Markdown 文件 | - | 聚类分析报告 |

### 3. 空间可视化输出

| 输出文件 | 数据类型 | 形状 | 说明 |
|---------|---------|------|------|
| `spatial_visualization.png` | PNG 图像 | - | 空间分布可视化 |

### 4. 聚类质量评估输出

| 输出文件 | 数据类型 | 形状 | 说明 |
|---------|---------|------|------|
| `cluster_quality_evaluation.png` | PNG 图像 | - | 聚类质量评估可视化 |
| `cluster_quality_report.md` | Markdown 文件 | - | 聚类质量评估报告 |

## 📊 数据流动路径

### 真实数据路径：
```
mouse_brain_squidpy.h5ad
  ├── adata.X → 基因表达矩阵 → 预处理 → 模型输入
  ├── adata.obsm['spatial'] → 空间坐标 → 空间图构建 → 模型输入
  └── adata.obsm['image_features'] → 图像特征 → 模型输入
```

### 模型处理路径：
```
输入数据
  ├── 基因表达 → GNN 编码器 → 中间表示
  ├── 图像特征 → 图像编码器 → 图像引导先验
  └── 空间图 → 空间注意力机制 → 增强特征

中间表示 + 图像引导先验 → 条件 VAE → 潜在表示 + KL 散度
```

### 结果分析路径：
```
潜在表示 → K-Means 聚类 → 空间域识别
  ├── 空间可视化 → 空间模式分析
  └── 质量评估 → 聚类效果验证

KL 散度 → 空间分布分析 → 形态与基因表达一致性评估
```

## 📝 注意事项

1. **图像特征要求**：
   - 真实数据必须包含 `image_features` 才能充分利用图像引导功能
   - 如果缺失，模型会自动使用零向量代替，但性能会下降

2. **空间坐标要求**：
   - 必须提供 `spatial` 坐标用于构建空间图
   - 坐标系统不影响模型训练（相对位置更重要）

3. **数据规模**：
   - 合成数据：固定 1000 个 spot
   - 真实数据：根据实际文件大小（示例中为 2688 个 spot）

4. **输出目录**：
   - 默认路径：`./outputs/image_guided_gvae/`
   - 可通过命令行参数 `--output` 自定义

## 📥 模型需要的输入数据

### 1. **基因表达矩阵** (Gene Expression)
- **形状**: `[N_spots, N_genes]`
- **类型**: 整数计数值（允许大量零值）
- **示例**: 
  ```
  [[  0,  15,   3, ...,   8],
   [  2,   8,   0, ...,  12],
   [  5,  20,   1, ...,   6]]
  ```
- **说明**: 每个空间点(spot)的基因表达计数，零膨胀分布

### 2. **空间坐标** (Spatial Coordinates)
- **形状**: `[N_spots, 2]`
- **类型**: 浮点数
- **示例**:
  ```
  [[1.2, 3.4],
   [1.5, 3.8],
   [1.8, 3.5]]
  ```
- **说明**: 每个 spot 在组织切片上的 (x, y) 坐标，用于构建空间邻接图

### 3. **图像特征** (Image Features) [可选]
- **形状**: `[N_spots, 1024]` (或其他维度)
- **类型**: 浮点数
- **来源**: 预训练模型提取（ResNet/UNI/ViT）
- **说明**: 每个 spot 对应区域的组织学图像特征
  - 若不提供，会使用零向量（仅用于测试）

### 4. **空间图** (Spatial Graph) [自动构建]
- 根据空间坐标自动构建 k-NN 或 Delaunay 图

---

## 📤 模型输出的结果

### 训练过程输出

#### 1. **训练日志**
```
Epoch   0 | Train Loss: 12.34 (Recon: 11.52, KL: 0.82, β: 0.000)
Epoch  10 | Train Loss: 10.23 (Recon:  9.51, KL: 0.72, β: 0.200)
...
```
- `Recon`: ZINB 重建损失
- `KL`: 条件 KL 散度
- `β`: KL annealing 权重

#### 2. **模型检查点**
- 文件: `checkpoint_epoch_N.pt`
- 包含: 模型参数、优化器状态、损失历史

### 推理输出

#### 3. **潜在表示** (Latent Representations)
- **形状**: `[N_spots, latent_dim]`
- **文件**: `latent_representations.npy`
- **用途**: 
  - 空间域识别（聚类）
  - UMAP/t-SNE 可视化
  - 下游分析（轨迹推断、差异分析）

#### 4. **KL 散度** (Per-Spot KL Divergence)
- **形状**: `[N_spots]`
- **文件**: `kl_divergence.npy`
- **意义**: 
  - 高 KL 值 → 图像与基因表达不一致的区域
  - **生物学发现点**: 肿瘤边界、免疫浸润、状态转换区域

#### 5. **重建的基因表达** (Reconstructed Expression)
ZINB 分布的三个参数：
- `mean` (μ): 期望计数
- `dispersion` (θ): 离散度
- `dropout` (π): 零膨胀概率

#### 6. **先验与后验分布**
- **先验** p(z|I,A): 仅基于图像和空间图
- **后验** q(z|X,I,A): 整合基因、图像和空间图
- 用于理解多模态信息融合

---

## 📊 数据规模示例

| 平台 | Spots | Genes | 图像特征维度 |
|------|-------|-------|-------------|
| 10x Visium | ~5,000 | ~2,000 | 1024 |
| Slide-seq | ~50,000 | ~1,500 | 1024 |
| MERFISH | ~100,000 | ~500 | 1024 |

---

## 🎯 核心创新

**Image-Guided Prior**: 图像作为先验条件，而非重建目标
- 避免维度灾难（不需要重建 224×224×3 的图像）
- 生物学可解释性：KL 散度识别形态-分子不一致区域
