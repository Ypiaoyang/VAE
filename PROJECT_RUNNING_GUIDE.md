# Image-Guided Graph VAE é¡¹ç›®è¿è¡ŒæŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

Image-Guided Graph VAEæ˜¯ä¸€ä¸ªç”¨äºç©ºé—´è½¬å½•ç»„å­¦åˆ†æçš„æ¡ä»¶å˜åˆ†è‡ªç¼–ç å™¨æ¨¡å‹ï¼Œå®ƒä½¿ç”¨ç»„ç»‡å›¾åƒä½œä¸ºå…ˆéªŒæ¡ä»¶æ¥å¼•å¯¼æ½œåœ¨ç©ºé—´åˆ†å¸ƒï¼Œè€Œä¸æ˜¯å°†å›¾åƒä½œä¸ºé‡æ„ç›®æ ‡ã€‚

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- åœ¨åˆæˆæˆ–çœŸå®ç©ºé—´è½¬å½•ç»„æ•°æ®ä¸Šè®­ç»ƒæ¨¡å‹
- æå–æ½œåœ¨è¡¨ç¤ºå’ŒKLæ•£åº¦æ¨¡å¼
- èšç±»åˆ†æè¯†åˆ«ç©ºé—´åŸŸ
- ç©ºé—´å¯è§†åŒ–å±•ç¤ºèšç±»ç»“æœå’ŒKLæ•£åº¦åˆ†å¸ƒ
- è¯„ä¼°èšç±»æ•ˆæœ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# å…‹éš†ä»“åº“
cd newproject

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Windows
env\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. è®­ç»ƒæ¨¡å‹

#### 2.1 åœ¨åˆæˆæ•°æ®ä¸Šè®­ç»ƒ

**å‘½ä»¤ï¼š**
```bash
python main.py --mode train_synthetic --device cpu --seed 42
```

**è¯´æ˜ï¼š**
- ç”Ÿæˆ1000ä¸ªç‚¹çš„åˆæˆç©ºé—´è½¬å½•ç»„æ•°æ®ï¼ŒåŒ…å«5ä¸ªç©ºé—´ç°‡
- ä½¿ç”¨KLé€€ç«è®­ç»ƒæ¨¡å‹
- æå–æ½œåœ¨è¡¨ç¤ºå’ŒKLæ•£åº¦æ¨¡å¼
- ç»“æœä¿å­˜åˆ° `./outputs/image_guided_gvae/`

**è¾“å‡ºæ–‡ä»¶ï¼š**
- æ¨¡å‹æ£€æŸ¥ç‚¹ï¼š`checkpoint_epoch_*.pt`
- æ½œåœ¨è¡¨ç¤ºï¼š`latent_representations.npy`
- KLæ•£åº¦ï¼š`kl_divergence.npy`
- çœŸå®æ ‡ç­¾ï¼š`true_labels.npy`

#### 2.2 åœ¨çœŸå®æ•°æ®ä¸Šè®­ç»ƒ

**å‘½ä»¤ï¼š**
```bash
python main.py --mode train_real \
    --data_path data/mouse_brain_squidpy.h5ad \
    --device cpu \
    --output ./outputs
```

**è¯´æ˜ï¼š**
- åŠ è½½çœŸå®ç©ºé—´è½¬å½•ç»„æ•°æ®
- æ„å»ºç©ºé—´å›¾
- è®­ç»ƒæ¨¡å‹
- æå–æ½œåœ¨è¡¨ç¤º

**é¢„æœŸæ•°æ®ç»“æ„ï¼ˆAnnDataï¼‰ï¼š**
- `adata.X`: åŸºå› è¡¨è¾¾çŸ©é˜µ
- `adata.obsm['spatial']`: ç©ºé—´åæ ‡
- `adata.obsm['image_features']`: é¢„æå–çš„å›¾åƒç‰¹å¾ï¼ˆå¯é€‰ï¼‰

### 3. èšç±»åˆ†æ

**å‘½ä»¤ï¼š**
```bash
python clustering_analysis.py
```

**åŠŸèƒ½ï¼š**
- åŠ è½½æ½œåœ¨è¡¨ç¤ºå’ŒKLæ•£åº¦
- ä½¿ç”¨è½®å»“ç³»æ•°ç¡®å®šæœ€ä½³èšç±»æ•°é‡ï¼ˆ2-10ï¼‰
- ä½¿ç”¨KMeansæ‰§è¡Œèšç±»
- ç”Ÿæˆèšç±»ç»“æœå¯è§†åŒ–
- ä¿å­˜èšç±»æ ‡ç­¾å’Œç°‡ä¸­å¿ƒ

**è¾“å‡ºæ–‡ä»¶ï¼š**
- èšç±»æ ‡ç­¾ï¼š`cluster_labels.npy`
- ç°‡ä¸­å¿ƒï¼š`cluster_centers.npy`
- èšç±»å¯è§†åŒ–ï¼š`clustering_analysis.png`
- èšç±»æŠ¥å‘Šï¼š`clustering_report.md`

### 4. ç©ºé—´å¯è§†åŒ–

**å‘½ä»¤ï¼š**
```bash
python spatial_visualization.py
```

**åŠŸèƒ½ï¼š**
- åŠ è½½èšç±»ç»“æœå’ŒKLæ•£åº¦
- åŠ è½½æˆ–ç”Ÿæˆç©ºé—´åæ ‡
- å¯è§†åŒ–èšç±»ç»“æœçš„ç©ºé—´åˆ†å¸ƒ
- å¯è§†åŒ–KLæ•£åº¦çš„ç©ºé—´åˆ†å¸ƒ
- ç»˜åˆ¶å„ç°‡çš„å¹³å‡KLæ•£åº¦å’Œç°‡å¤§å°åˆ†å¸ƒ

**è¾“å‡ºæ–‡ä»¶ï¼š**
- ç©ºé—´å¯è§†åŒ–ï¼š`spatial_visualization.png`

### 5. èšç±»æ•ˆæœè¯„ä¼°

**å‘½ä»¤ï¼š**
```bash
python evaluate_clustering.py
```

**åŠŸèƒ½ï¼š**
- åŠ è½½æºæ•°æ®å’Œèšç±»ç»“æœ
- è®¡ç®—èšç±»è´¨é‡æŒ‡æ ‡ï¼š
  - è½®å»“ç³»æ•°ï¼ˆSilhouette Scoreï¼‰
  - æˆ´ç»´æ–¯-å¸ƒéš†ä¸æŒ‡æ•°ï¼ˆDavies-Bouldin Indexï¼‰
  - å¡åˆ©æ–¯åŸº-å“ˆæ‹‰å·´æ–¯æŒ‡æ•°ï¼ˆCalinski-Harabasz Indexï¼‰
  - ç©ºé—´è¿ç»­æ€§å¾—åˆ†
- ç”Ÿæˆèšç±»è´¨é‡å¯è§†åŒ–
- ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š

**è¾“å‡ºæ–‡ä»¶ï¼š**
- èšç±»è´¨é‡å¯è§†åŒ–ï¼š`cluster_quality_evaluation.png`
- è¯„ä¼°æŠ¥å‘Šï¼š`cluster_quality_report.md`

## ğŸ“ é¡¹ç›®ç»“æ„

```
newproject/
â”œâ”€â”€ models/                # æ¨¡å‹æ¶æ„
â”‚   â”œâ”€â”€ layers.py         # ZINBæŸå¤±å’ŒKLæ•£åº¦
â”‚   â””â”€â”€ cvae.py           # Image-Guided GVAEæ¶æ„
â”œâ”€â”€ data/                 # æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ dataset.py        # æ•°æ®é›†ç±»
â”‚   â””â”€â”€ mouse_brain_squidpy.h5ad  # ç¤ºä¾‹çœŸå®æ•°æ®
â”œâ”€â”€ utils/                # å·¥å…·
â”‚   â””â”€â”€ config.py         # é…ç½®ç®¡ç†
â”œâ”€â”€ main.py               # ä¸»å…¥å£
â”œâ”€â”€ trainer.py            # è®­ç»ƒé€»è¾‘
â”œâ”€â”€ clustering_analysis.py # èšç±»åˆ†æ
â”œâ”€â”€ spatial_visualization.py # ç©ºé—´å¯è§†åŒ–
â”œâ”€â”€ evaluate_clustering.py # èšç±»æ•ˆæœè¯„ä¼°
â”œâ”€â”€ requirements.txt      # ä¾èµ–
â””â”€â”€ README.md             # é¡¹ç›®è¯´æ˜
```

## ğŸ§ª ç¤ºä¾‹å·¥ä½œæµç¨‹

### å®Œæ•´è¿è¡Œæµç¨‹

1. **è®­ç»ƒæ¨¡å‹**
   ```bash
   python main.py --mode train_synthetic --device cpu --seed 42
   ```

2. **èšç±»åˆ†æ**
   ```bash
   python clustering_analysis.py
   ```

3. **ç©ºé—´å¯è§†åŒ–**
   ```bash
   python spatial_visualization.py
   ```

4. **èšç±»æ•ˆæœè¯„ä¼°**
   ```bash
   python evaluate_clustering.py
   ```

### çœŸå®æ•°æ®è¿è¡Œæµç¨‹

1. **å‡†å¤‡æ•°æ®**
   - ç¡®ä¿æ•°æ®æ ¼å¼ä¸ºAnnData (.h5ad)
   - åŒ…å«åŸºå› è¡¨è¾¾çŸ©é˜µå’Œç©ºé—´åæ ‡

2. **è®­ç»ƒæ¨¡å‹**
   ```bash
   python main.py --mode train_real --data_path data/mouse_brain_squidpy.h5ad --device cpu
   ```

3. **èšç±»åˆ†æ**
   ```bash
   python clustering_analysis.py
   ```

4. **ç©ºé—´å¯è§†åŒ–**
   ```bash
   python spatial_visualization.py
   ```

5. **èšç±»æ•ˆæœè¯„ä¼°**
   ```bash
   python evaluate_clustering.py
   ```

## ğŸ“Š ç»“æœè§£é‡Š

### èšç±»è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | è§£é‡Š |
|------|------|------|
| è½®å»“ç³»æ•° | è¯„ä¼°ç°‡å†…ç´§å¯†æ€§å’Œç°‡é—´åˆ†ç¦»åº¦ | è¶Šæ¥è¿‘1è¶Šå¥½ |
| æˆ´ç»´æ–¯-å¸ƒéš†ä¸æŒ‡æ•° | è¯„ä¼°ç°‡çš„åˆ†ç¦»åº¦å’Œç´§å¯†åº¦ | è¶Šå°è¶Šå¥½ |
| å¡åˆ©æ–¯åŸº-å“ˆæ‹‰å·´æ–¯æŒ‡æ•° | è¯„ä¼°ç°‡å†…æ–¹å·®å’Œç°‡é—´æ–¹å·®çš„æ¯”å€¼ | è¶Šå¤§è¶Šå¥½ |
| ç©ºé—´è¿ç»­æ€§å¾—åˆ† | è¯„ä¼°èšç±»ç»“æœçš„ç©ºé—´è¿ç»­æ€§ | è¶Šæ¥è¿‘1è¶Šå¥½ |

### KLæ•£åº¦è§£é‡Š

- **é«˜KLæ•£åº¦**ï¼šå½¢æ€ä¸åŸºå› è¡¨è¾¾ä¸ä¸€è‡´çš„åŒºåŸŸï¼Œå¯èƒ½æ˜¯ç”Ÿç‰©å‘ç°çš„çƒ­ç‚¹
- **ä½KLæ•£åº¦**ï¼šå½¢æ€ä¸åŸºå› è¡¨è¾¾é«˜åº¦ä¸€è‡´çš„åŒºåŸŸ
- **ç©ºé—´åˆ†å¸ƒ**ï¼šå¯è§†åŒ–KLæ•£åº¦çš„ç©ºé—´æ¨¡å¼å¯ä»¥è¯†åˆ«ç»„ç»‡ä¸­çš„ç‰¹æ®ŠåŒºåŸŸ

## ğŸ”§ é…ç½®é€‰é¡¹

### å‘½ä»¤è¡Œå‚æ•°

**main.py**
```
--mode: è¿è¡Œæ¨¡å¼ (train_synthetic, train_real, extract)
--data_path: çœŸå®æ•°æ®è·¯å¾„
--config: é…ç½®æ–‡ä»¶è·¯å¾„
--checkpoint: æ¨¡å‹æ£€æŸ¥ç‚¹è·¯å¾„
--output: è¾“å‡ºç›®å½•
--device: è®¾å¤‡ (cpu, cuda)
--seed: éšæœºç§å­
```

### é…ç½®æ–‡ä»¶ (config.json)

```json
{
  "model": {
    "input_dim": 2000,
    "img_dim": 128,
    "hidden_dim": 128,
    "latent_dim": 32,
    "num_heads": 4,
    "dropout": 0.2
  },
  "training": {
    "epochs": 200,
    "batch_size": 64,
    "learning_rate": 1e-3,
    "weight_decay": 1e-4,
    "kl_annealing_start": 0,
    "kl_annealing_end": 100,
    "kl_weight_max": 0.1,
    "gradient_clip": 5.0,
    "log_interval": 10,
    "save_interval": 50
  },
  "data": {
    "graph_type": "knn",
    "k_neighbors": 6,
    "normalize_total": true,
    "log_transform": true,
    "highly_variable_genes": 2000
  },
  "experiment_name": "image_guided_gvae"
}
```

## ğŸ“ˆ å¯è§†åŒ–ç»“æœ

### 1. èšç±»åˆ†æå¯è§†åŒ–

**æ–‡ä»¶ï¼š** `outputs/image_guided_gvae/clustering_analysis.png`

**å†…å®¹ï¼š**
- è‚˜éƒ¨æ³•åˆ™å›¾
- è½®å»“ç³»æ•°åˆ†æ
- æ½œåœ¨ç©ºé—´èšç±»ç»“æœ
- å„ç°‡KLæ•£åº¦åˆ†å¸ƒ

### 2. ç©ºé—´å¯è§†åŒ–

**æ–‡ä»¶ï¼š** `outputs/image_guided_gvae/spatial_visualization.png`

**å†…å®¹ï¼š**
- èšç±»ç»“æœç©ºé—´åˆ†å¸ƒ
- KLæ•£åº¦ç©ºé—´åˆ†å¸ƒ
- å„ç°‡å¹³å‡KLæ•£åº¦æŸ±çŠ¶å›¾
- ç°‡å¤§å°åˆ†å¸ƒé¥¼å›¾

### 3. èšç±»è´¨é‡è¯„ä¼°

**æ–‡ä»¶ï¼š** `outputs/image_guided_gvae/cluster_quality_evaluation.png`

**å†…å®¹ï¼š**
- èšç±»ç»“æœç©ºé—´åˆ†å¸ƒ
- èšç±»ç»“æœUMAPåˆ†å¸ƒ

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®æ ¼å¼**
   - çœŸå®æ•°æ®éœ€è¦æ˜¯AnnDataæ ¼å¼ (.h5ad)
   - å¿…é¡»åŒ…å«ç©ºé—´åæ ‡ (`adata.obsm['spatial']`)

2. **ç¡¬ä»¶è¦æ±‚**
   - è®­ç»ƒæ¨¡å‹å»ºè®®ä½¿ç”¨GPU
   - å¯¹äºå¤§å‹æ•°æ®é›†ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´batch_sizeå’Œæ¨¡å‹å‚æ•°

3. **ç»“æœè§£é‡Š**
   - KLæ•£åº¦é«˜çš„åŒºåŸŸå¯èƒ½åŒ…å«é‡è¦çš„ç”Ÿç‰©ä¿¡æ¯
   - ç©ºé—´è¿ç»­æ€§å·®å¯èƒ½æ„å‘³ç€éœ€è¦ä½¿ç”¨ç©ºé—´çº¦æŸçš„èšç±»æ–¹æ³•

4. **è°ƒè¯•**
   - å¦‚æœé‡åˆ°å†…å­˜é—®é¢˜ï¼Œå°è¯•å‡å°‘æ¨¡å‹å¤§å°æˆ–æ‰¹é‡å¤§å°
   - å¦‚æœè®­ç»ƒä¸ç¨³å®šï¼Œè°ƒæ•´å­¦ä¹ ç‡æˆ–KLé€€ç«å‚æ•°

## ğŸ“š è¿›ä¸€æ­¥åˆ†æ

1. **å·®å¼‚è¡¨è¾¾åˆ†æ**
   - è¯†åˆ«æ¯ä¸ªç°‡çš„æ ‡å¿—åŸºå› 
   - ç†è§£æ¯ä¸ªç©ºé—´åŸŸçš„ç”Ÿç‰©å­¦åŠŸèƒ½

2. **åŠŸèƒ½å¯Œé›†åˆ†æ**
   - åˆ†ææ ‡å¿—åŸºå› çš„ç”Ÿç‰©å­¦åŠŸèƒ½
   - è¯†åˆ«é‡è¦çš„é€šè·¯å’Œç”Ÿç‰©å­¦è¿‡ç¨‹

3. **ç©ºé—´æ¨¡å¼åˆ†æ**
   - è¯†åˆ«ç©ºé—´åŸŸä¹‹é—´çš„è¾¹ç•Œ
   - åˆ†æç©ºé—´åŸŸçš„ç©ºé—´å…³ç³»

4. **å¤šç»„å­¦æ•´åˆ**
   - æ•´åˆåŸºå› è¡¨è¾¾å’Œå›¾åƒç‰¹å¾
   - æ¢ç´¢å½¢æ€ä¸åˆ†å­çš„å…³ç³»

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰